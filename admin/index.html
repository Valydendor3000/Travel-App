<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TripStack Admin</title>
  <style>
    :root { --p:#0ea5e9; --pd:#0284c7; --b:#0f172a; --m:#64748b; --bd:#e2e8f0; --bg:#f8fafc; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--b); }
    header { background:var(--p); color:#fff; padding:16px; }
    h1 { margin:0; font-size:20px; }
    main { padding:16px; display:grid; gap:16px; grid-template-columns: repeat(auto-fit,minmax(360px,1fr)); }
    .card { background:#fff; border:1px solid var(--bd); border-radius:14px; padding:16px; }
    h2 { margin:0 0 8px; font-size:18px; }
    p { margin:6px 0 0; color:var(--m); }
    label { display:block; font-size:12px; color:var(--m); margin-top:10px; }
    input, textarea {
      width:100%; padding:10px; border:1px solid var(--bd); border-radius:10px; font-size:14px; background:#fff;
    }
    input[type="checkbox"] { width:auto; margin-right:6px; vertical-align:middle; }
    textarea { min-height:90px; }
    button {
      margin-top:12px; background:var(--p); color:#fff; border:none;
      padding:10px 14px; font-weight:800; border-radius:10px; cursor:pointer;
    }
    button:active { background:var(--pd); }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .muted { color:var(--m); font-size:12px; }
    .ok { color:#047857; font-weight:800; }
    .err { color:#b91c1c; font-weight:800; }
    .list { margin-top:8px; display:grid; gap:8px; max-height:360px; overflow:auto; }
    .item { border:1px solid var(--bd); border-radius:12px; padding:10px; background:#fff; display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .item h3 { margin:0; font-size:14px; }
    .pill { font-size:11px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; display:inline-block; }
    .danger { background:#ef4444; }
    .danger:active { background:#dc2626; }

    .tabs { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .tabBtn {
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.25);
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor: pointer;
      margin-top: 0;
    }
    .tabBtn.active { background:#fff; color: var(--p); border-color:#fff; }

    /* modal */
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(15,23,42,.45); padding:16px; z-index:50; overflow:auto; }
    .modalBox { max-width:980px; margin:0 auto; background:#fff; border:1px solid var(--bd); border-radius:16px; overflow:hidden; }
    .modalHeader { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; background:var(--p); color:#fff; gap:12px; }
    .modalHeaderTitle { font-weight:900; font-size:16px; }
    .modalHeaderSub { opacity:.9; font-size:12px; margin-top:2px; }
    .modalCloseBtn { background:var(--pd); border:none; color:#fff; padding:8px 12px; border-radius:10px; font-weight:900; cursor:pointer; margin-top:0; }
    .modalBody { padding:16px; display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .inlineBtns { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .tiny { font-size:11px; }
  </style>
</head>
<body>
  <header>
    <h1>TripStack Admin</h1>
    <div class="tabs">
      <button class="tabBtn active" data-tab="trips">Trips</button>
      <button class="tabBtn" data-tab="payments">Payments</button>
      <button class="tabBtn" data-tab="socials">Socials</button>
    </div>
  </header>

  <!-- Settings -->
  <section class="card" style="margin:16px">
    <h2>Settings</h2>
    <p>Saved in your browser (localStorage). Update anytime.</p>

    <div class="row" style="margin-top:10px">
      <div>
        <label>API base URL</label>
        <input id="cfgApi" placeholder="https://your-worker.your-account.workers.dev" />
        <div class="muted" style="margin-top:6px">Example: https://travel-app.thebusinessshapeup.workers.dev</div>
      </div>
      <div>
        <label>Admin Token</label>
        <input id="cfgToken" placeholder="paste your ADMIN_TOKEN" />
        <div class="muted" style="margin-top:6px">Sent as: Authorization: Bearer &lt;token&gt;</div>
      </div>
    </div>

    <button id="saveCfgBtn">Save</button>
    <span id="cfgMsg" class="muted" style="margin-left:8px"></span>
  </section>

  <!-- TRIPS TAB -->
  <main id="tab-trips" style="display:grid">
    <section class="card">
      <h2>Create Trip</h2>

      <div class="row">
        <div>
          <label>Group ID</label>
          <input id="tripGroupId" placeholder="e.g. g1" />
        </div>
        <div>
          <label>Title</label>
          <input id="tripTitle" placeholder="e.g. Caribbean Cruise Adventure" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Start Date</label>
          <input id="tripStart" type="date" />
        </div>
        <div>
          <label>End Date</label>
          <input id="tripEnd" type="date" />
        </div>
      </div>

      <label>Notes</label>
      <textarea id="tripNotes" placeholder="Extra info for your travelers…"></textarea>

      <div class="row" style="margin-top:8px">
        <label><input type="checkbox" id="tripCruise" /> Cruise</label>
        <label><input type="checkbox" id="tripFlights" /> Flights</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="tripHotel" /> Hotel rooms</label>
        <label><input type="checkbox" id="tripAI" /> All-inclusive</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="tripPublic" /> Public</label>
        <div></div>
      </div>

      <button id="createTripBtn">Create Trip</button>
      <div id="tripStatus" class="muted" style="margin-top:8px"></div>
    </section>

    <section class="card">
      <h2>Trips List</h2>

      <div class="row">
        <div>
          <label>Group ID to view</label>
          <input id="tripListGroupId" placeholder="e.g. g1" />
        </div>
        <div style="display:flex; align-items:flex-end">
          <button id="refreshTripsBtn">Refresh</button>
        </div>
      </div>

      <div id="tripList" class="list"></div>
    </section>
  </main>

  <!-- PAYMENTS TAB -->
  <main id="tab-payments" style="display:none">
    <section class="card">
      <h2>Add Payment Link</h2>
      <div class="row">
        <div>
          <label>Group ID</label>
          <input id="payGroupId" placeholder="e.g. g1" />
        </div>
        <div>
          <label>Label</label>
          <input id="payLabel" placeholder="e.g. Deposit • Per Person" />
        </div>
      </div>

      <label>Vendor URL</label>
      <input id="payVendor" placeholder="https://vendor.example.com/pay/abc" />
      <label>Due Date</label>
      <input id="payDue" type="date" />

      <button id="createPayBtn">Add Payment Link</button>
      <div id="payStatus" class="muted" style="margin-top:8px"></div>
    </section>

    <section class="card">
      <h2>Payment Links</h2>
      <div class="row">
        <div>
          <label>Group ID to view</label>
          <input id="payListGroupId" placeholder="e.g. g1" />
        </div>
        <div style="display:flex; align-items:flex-end">
          <button id="refreshPaysBtn">Refresh</button>
        </div>
      </div>
      <div id="payList" class="list"></div>
    </section>
  </main>

  <!-- SOCIALS TAB -->
  <main id="tab-socials" style="display:none">
    <section class="card">
      <h2>Brand Socials</h2>
      <div class="row">
        <div>
          <label>Brand ID</label>
          <input id="brandId" placeholder="e.g. b1" />
        </div>
        <div style="display:flex; align-items:flex-end">
          <button id="loadBrandBtn">Load</button>
        </div>
      </div>

      <label>Facebook URL</label>
      <input id="fbUrl" placeholder="https://facebook.com/yourpage" />
      <label>Instagram URL</label>
      <input id="igUrl" placeholder="https://instagram.com/yourpage" />
      <label>Twitter/X URL</label>
      <input id="twUrl" placeholder="https://x.com/yourhandle" />
      <label>TikTok URL</label>
      <input id="ttUrl" placeholder="https://tiktok.com/@yourhandle" />

      <button id="saveBrandBtn">Save Socials</button>
      <div id="brandMsg" class="muted" style="margin-top:8px"></div>
    </section>
  </main>

  <!-- Manage Details Modal -->
  <div id="manageModal" class="modalOverlay">
    <div class="modalBox">
      <div class="modalHeader">
        <div>
          <div class="modalHeaderTitle">Manage Trip Details</div>
          <div id="manageSubtitle" class="modalHeaderSub"></div>
        </div>
        <button id="manageClose" class="modalCloseBtn">Close</button>
      </div>

      <div class="modalBody">
        <div class="card">
          <h2>Cruise cabins</h2>
          <div class="row">
            <div><label>Cabin #</label><input id="cabinNo" placeholder="e.g., 8256" /></div>
            <div><label>Category</label><input id="cabinCat" placeholder="e.g., Balcony" /></div>
          </div>
          <div class="row">
            <div><label>Deck</label><input id="cabinDeck" placeholder="e.g., 8" /></div>
            <div><label>Guests</label><input id="cabinGuests" type="number" placeholder="2" /></div>
          </div>
          <label>Notes</label>
          <input id="cabinNotes" placeholder="Optional notes" />
          <button id="addCabinBtn">Add cabin</button>
          <div class="muted tiny" style="margin-top:8px">Delete works only if Worker has DELETE /api/cruise-cabins/:id</div>
          <div id="cabinsList" class="list"></div>
        </div>

        <div class="card">
          <h2>Flights</h2>
          <div class="row">
            <div><label>Carrier</label><input id="fltCarrier" placeholder="e.g., AA" /></div>
            <div><label>Flight #</label><input id="fltNo" placeholder="e.g., 1234" /></div>
          </div>
          <div class="row">
            <div><label>Depart airport</label><input id="fltDep" placeholder="ATL" /></div>
            <div><label>Arrive airport</label><input id="fltArr" placeholder="MIA" /></div>
          </div>
          <div class="row">
            <div><label>Depart (date/time)</label><input id="fltDepTs" type="datetime-local" /></div>
            <div><label>Arrive (date/time)</label><input id="fltArrTs" type="datetime-local" /></div>
          </div>
          <label>Record locator</label>
          <input id="fltRec" placeholder="Optional" />
          <button id="addFlightBtn">Add flight segment</button>
          <div class="muted tiny" style="margin-top:8px">Delete works only if Worker has DELETE /api/flight-segments/:id</div>
          <div id="flightsList" class="list"></div>
        </div>

        <div class="card">
          <h2>Hotel rooms</h2>
          <label>Hotel name</label>
          <input id="hotelName" placeholder="Hotel" />
          <label>Room type</label>
          <input id="hotelRoomType" placeholder="King / Double / Suite" />
          <div class="row">
            <div><label>Check-in</label><input id="hotelIn" type="datetime-local" /></div>
            <div><label>Check-out</label><input id="hotelOut" type="datetime-local" /></div>
          </div>
          <div class="row">
            <div><label>Occupants</label><input id="hotelOcc" type="number" placeholder="2" /></div>
            <div><label>Confirmation</label><input id="hotelConf" placeholder="Optional" /></div>
          </div>
          <button id="addHotelBtn">Add room</button>
          <div class="muted tiny" style="margin-top:8px">Delete works only if Worker has DELETE /api/hotel-rooms/:id</div>
          <div id="hotelsList" class="list"></div>
        </div>

        <div class="card">
          <h2>All-inclusive</h2>
          <label>Resort name</label>
          <input id="aiResort" placeholder="Resort" />
          <label>Plan name</label>
          <input id="aiPlan" placeholder="Package / Plan" />
          <div class="row">
            <div><label>Check-in</label><input id="aiIn" type="datetime-local" /></div>
            <div><label>Check-out</label><input id="aiOut" type="datetime-local" /></div>
          </div>
          <div class="row">
            <div><label>Occupants</label><input id="aiOcc" type="number" placeholder="2" /></div>
            <div><label>Confirmation</label><input id="aiConf" placeholder="Optional" /></div>
          </div>
          <button id="addAIBtn">Add package</button>
          <div class="muted tiny" style="margin-top:8px">Delete works only if Worker has DELETE /api/ai-packages/:id</div>
          <div id="aiList" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Helpers / Config
    // ----------------------------
    const $ = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function normalizeUrl(u) {
      const s = String(u || "").trim();
      if (!s) return "#";
      return /^https?:\/\//i.test(s) ? s : ("https://" + s);
    }

    function show(el, on=true){ el.style.display = on ? "block" : "none"; }
    function dtToTs(v){ return v ? Math.floor(new Date(v).getTime()/1000) : null; }

    // localStorage-backed config
    const cfg = {
      load() {
        $("cfgApi").value = localStorage.getItem("admin.api") || "";
        $("cfgToken").value = localStorage.getItem("admin.token") || "";
      },
      save() {
        localStorage.setItem("admin.api", $("cfgApi").value.trim());
        localStorage.setItem("admin.token", $("cfgToken").value.trim());
        $("cfgMsg").textContent = "✅ Saved";
        setTimeout(() => ($("cfgMsg").textContent = ""), 1500);
      },
      get api() { return ($("cfgApi").value || "").trim().replace(/\/+$/,""); },
      get token() { return ($("cfgToken").value || "").trim(); }
    };

    cfg.load();

    // Fetch wrapper (adds Authorization automatically when token is set)
    async function apiFetch(path, opts = {}) {
      if (!cfg.api) throw new Error("Set API base URL in Settings first.");
      const headers = Object.assign(
        { "Content-Type": "application/json" },
        opts.headers || {},
        cfg.token ? { "Authorization": "Bearer " + cfg.token } : {}
      );

      const res = await fetch(cfg.api + path, { ...opts, headers });
      const ct = res.headers.get("content-type") || "";
      const body = ct.includes("application/json") ? await res.json() : await res.text();

      if (!res.ok) {
        const msg = typeof body === "string" ? body : (body?.error || "Request failed");
        throw new Error(msg);
      }
      return body;
    }

    // Tabs switching
    document.querySelectorAll(".tabBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const id = btn.dataset.tab;
        document.querySelectorAll("main[id^='tab-']").forEach(m => m.style.display = "none");
        $("tab-" + id).style.display = (id === "trips") ? "grid" : "block";
      });
    });

    $("saveCfgBtn").onclick = async () => {
      cfg.save();
      try { await loadTrips(); } catch {}
      try { await loadPayments(); } catch {}
    };

    // ----------------------------
    // Trips: Create + List + Actions
    // ----------------------------
    $("createTripBtn").onclick = async () => {
      $("tripStatus").textContent = "";
      try {
        const group_id = ($("tripGroupId").value.trim() || "g1");
        const title = $("tripTitle").value.trim();
        if (!title) throw new Error("Title is required.");

        const start = $("tripStart").value ? Math.floor(new Date($("tripStart").value).getTime()/1000) : null;
        const end   = $("tripEnd").value   ? Math.floor(new Date($("tripEnd").value).getTime()/1000)   : null;

        const body = {
          group_id,
          title,
          start_date: start,
          end_date: end,
          notes: $("tripNotes").value.trim() || null,
          has_cruise: $("tripCruise").checked,
          has_flights: $("tripFlights").checked,
          has_hotel: $("tripHotel").checked,
          has_all_inclusive: $("tripAI").checked,
          is_public: $("tripPublic").checked
        };

        await apiFetch("/api/trips", { method: "POST", body: JSON.stringify(body) });
        $("tripStatus").textContent = "✅ Trip created";
        await loadTrips();
      } catch (e) {
        $("tripStatus").textContent = "❌ " + e.message;
      }
    };

    $("refreshTripsBtn").onclick = loadTrips;

    async function loadTrips() {
      const gid = (($("tripListGroupId")?.value || "g1").trim());
      const list = $("tripList");
      list.innerHTML = '<div class="muted">Loading…</div>';

      try {
        const raw = await apiFetch(`/api/trips?groupId=${encodeURIComponent(gid)}`);
        const trips = Array.isArray(raw) ? raw : (raw?.results ?? []);

        if (!Array.isArray(trips) || trips.length === 0) {
          list.innerHTML = '<div class="muted">No trips found for this group.</div>';
          return;
        }

        list.innerHTML = trips.map(t => {
          const start = t.start_date ? new Date(t.start_date * 1000).toLocaleDateString() : "TBD";
          const end   = t.end_date   ? new Date(t.end_date * 1000).toLocaleDateString()   : "TBD";
          const vis   = t.is_public ? "Public" : "Private";
          const idEsc = escapeHtml(t.id);

          return `
            <div class="item">
              <div>
                <h3>${escapeHtml(t.title || "Untitled")}</h3>
                <div class="muted">${escapeHtml(start)} — ${escapeHtml(end)}</div>
                <div style="margin-top:6px">
                  <span class="pill">${escapeHtml(vis)}</span>
                </div>
              </div>

              <div class="inlineBtns">
                <button data-action="manage" data-id="${idEsc}">Manage Details</button>
                <button data-action="toggle" data-id="${idEsc}">
                  ${t.is_public ? "Make Private" : "Make Public"}
                </button>
                <button class="danger" data-action="delete" data-id="${idEsc}">Delete</button>
              </div>
            </div>
          `;
        }).join("");

      } catch (e) {
        list.innerHTML = `<div class="err">Failed to load trips: ${escapeHtml(e.message)}</div>`;
      }
    }

    // One click handler for ALL trip list buttons
    $("tripList").addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;

      if (action === "delete") {
        if (!confirm("Delete this trip?")) return;
        try {
          await apiFetch(`/api/trips/${encodeURIComponent(id)}`, { method: "DELETE" });
          await loadTrips();
        } catch (err) {
          alert("Delete failed: " + err.message);
        }
        return;
      }

      if (action === "toggle") {
        try {
          const t = await apiFetch(`/api/trips/${encodeURIComponent(id)}`);
          const next = !t.is_public;

          // IMPORTANT: your Worker supports /visibility for public/private
          await apiFetch(`/api/trips/${encodeURIComponent(id)}/visibility`, {
            method: "PUT",
            body: JSON.stringify({ is_public: next })
          });

          await loadTrips();
        } catch (err) {
          alert("Toggle failed: " + err.message);
        }
        return;
      }

      if (action === "manage") {
        await openManageModal(id);
        return;
      }
    });

    // ----------------------------
    // Payments
    // ----------------------------
    $("createPayBtn").onclick = async () => {
      $("payStatus").textContent = "";
      try {
        const groupId = ($("payGroupId").value.trim() || "g1");
        const label = $("payLabel").value.trim();
        const vendor_url = $("payVendor").value.trim();
        if (!label || !vendor_url) throw new Error("Label and Vendor URL are required.");

        const due_at = $("payDue").value ? Math.floor(new Date($("payDue").value).getTime()/1000) : null;

        await apiFetch(`/api/groups/${encodeURIComponent(groupId)}/payments`, {
          method: "POST",
          body: JSON.stringify({ label, vendor_url, due_at })
        });

        $("payStatus").textContent = "✅ Payment link added";
        await loadPayments();
      } catch (e) {
        $("payStatus").textContent = "❌ " + e.message;
      }
    };

    $("refreshPaysBtn").onclick = loadPayments;

    async function loadPayments() {
      const gid = (($("payListGroupId").value || "g1").trim());
      const list = $("payList");
      list.innerHTML = '<div class="muted">Loading…</div>';

      try {
        const items = await apiFetch(`/api/groups/${encodeURIComponent(gid)}/payments`);
        const rows = Array.isArray(items) ? items : (items?.results ?? []);
        if (!rows.length) {
          list.innerHTML = '<div class="muted">No payment links found.</div>';
          return;
        }
        list.innerHTML = rows.map(p => {
          const due = p.due_at ? new Date(p.due_at * 1000).toLocaleDateString() : "";
          const href = normalizeUrl(p.vendor_url);
          return `
            <div class="item">
              <div>
                <h3>${escapeHtml(p.label || "Payment")}</h3>
                ${due ? `<div class="muted">Due: ${escapeHtml(due)}</div>` : `<div class="muted">No due date</div>`}
              </div>
              <div>
                <a class="pill" href="${escapeHtml(href)}" target="_blank" rel="noreferrer">Open</a>
              </div>
            </div>
          `;
        }).join("");
      } catch (e) {
        list.innerHTML = `<div class="err">Failed to load payments: ${escapeHtml(e.message)}</div>`;
      }
    }

    // ----------------------------
    // Socials
    // ----------------------------
    $("loadBrandBtn").onclick = loadBrand;
    $("saveBrandBtn").onclick = saveBrand;

    async function loadBrand() {
      $("brandMsg").textContent = "";
      const id = ($("brandId").value.trim() || "b1");
      try {
        const data = await apiFetch(`/api/brands/${encodeURIComponent(id)}/socials`);
        $("fbUrl").value = data.facebook_url || "";
        $("igUrl").value = data.instagram_url || "";
        $("twUrl").value = data.twitter_url || "";
        $("ttUrl").value = data.tiktok_url || "";
        $("brandMsg").textContent = "✅ Loaded";
      } catch (e) {
        $("brandMsg").textContent = "❌ " + e.message;
      }
    }

    async function saveBrand() {
      $("brandMsg").textContent = "";
      const id = ($("brandId").value.trim() || "b1");
      try {
        const body = {
          facebook_url: $("fbUrl").value.trim() || null,
          instagram_url: $("igUrl").value.trim() || null,
          twitter_url: $("twUrl").value.trim() || null,
          tiktok_url: $("ttUrl").value.trim() || null
        };
        await apiFetch(`/api/brands/${encodeURIComponent(id)}/socials`, {
          method: "POST",
          body: JSON.stringify(body)
        });
        $("brandMsg").textContent = "✅ Saved";
      } catch (e) {
        $("brandMsg").textContent = "❌ " + e.message;
      }
    }

    // ----------------------------
    // Manage Modal (Option 2) + Delete Details FIXED
    // ----------------------------
    let currentTripId = null;

    $("manageClose").onclick = () => {
      show($("manageModal"), false);
      currentTripId = null;
    };

    async function openManageModal(tripId){
      currentTripId = tripId;
      show($("manageModal"), true);

      // get core trip info (for header)
      let trip = null;
      try { trip = await apiFetch(`/api/trips/${encodeURIComponent(tripId)}`); } catch {}
      $("manageSubtitle").textContent = trip
        ? `${trip.title || "Untitled"} • ${trip.group_id || ""} • ${trip.is_public ? "Public" : "Private"} • Trip ID: ${tripId}`
        : `Trip ID: ${tripId}`;

      await refreshManageModal();
    }

    async function refreshManageModal(){
      if(!currentTripId) return;

      const data = await apiFetch(`/api/trips/${encodeURIComponent(currentTripId)}/full`);

      // Cabins
      const cabins = Array.isArray(data.cruise_cabins) ? data.cruise_cabins : [];
      $("cabinsList").innerHTML = cabins.length
        ? cabins.map(c => `
            <div class="item">
              <div>
                <h3>${escapeHtml(c.cabin_no || "Cabin")}</h3>
                <div class="muted">${escapeHtml([c.category, c.deck ? `Deck ${c.deck}` : ""].filter(Boolean).join(" · "))}</div>
                ${c.notes ? `<div class="muted" style="margin-top:4px">${escapeHtml(c.notes)}</div>` : ""}
              </div>
              <div class="inlineBtns">
                <span class="pill">${c.guests ? `${c.guests} guests` : "—"}</span>
                <button class="danger" data-del="cabin" data-id="${escapeHtml(c.id)}">Delete</button>
              </div>
            </div>
          `).join("")
        : '<div class="muted">No cabins yet.</div>';

      // Flights (FIXED: render to flightsList)
      const flights = Array.isArray(data.flight_segments) ? data.flight_segments : [];
      $("flightsList").innerHTML = flights.length
        ? flights.map(f => `
            <div class="item">
              <div>
                <h3>${escapeHtml([f.carrier, f.flight_no].filter(Boolean).join(" ") || "Flight")}</h3>
                <div class="muted">${escapeHtml([f.depart_airport, "→", f.arrive_airport].filter(Boolean).join(" "))}</div>
                ${f.record_locator ? `<div class="muted">Locator: ${escapeHtml(f.record_locator)}</div>` : ""}
              </div>
              <div class="inlineBtns">
                <span class="pill">Flights</span>
                <button class="danger" data-del="flight" data-id="${escapeHtml(f.id)}">Delete</button>
              </div>
            </div>
          `).join("")
        : '<div class="muted">No flights yet.</div>';

      // Hotels
      const hotels = Array.isArray(data.hotel_rooms) ? data.hotel_rooms : [];
      $("hotelsList").innerHTML = hotels.length
        ? hotels.map(h => `
            <div class="item">
              <div>
                <h3>${escapeHtml(h.hotel_name || "Hotel")}</h3>
                <div class="muted">${escapeHtml([h.room_type || "Room", h.occupants ? `${h.occupants} occupants` : ""].filter(Boolean).join(" · "))}</div>
                ${h.confirmation ? `<div class="muted">Conf: ${escapeHtml(h.confirmation)}</div>` : ""}
              </div>
              <div class="inlineBtns">
                <span class="pill">Hotel</span>
                <button class="danger" data-del="hotel" data-id="${escapeHtml(h.id)}">Delete</button>
              </div>
            </div>
          `).join("")
        : '<div class="muted">No hotel rooms yet.</div>';

      // AI
      const ai = Array.isArray(data.all_inclusive) ? data.all_inclusive : [];
      $("aiList").innerHTML = ai.length
        ? ai.map(a => `
            <div class="item">
              <div>
                <h3>${escapeHtml(a.resort_name || "Resort")}</h3>
                <div class="muted">${escapeHtml([a.plan_name || "Plan", a.occupants ? `${a.occupants} occupants` : ""].filter(Boolean).join(" · "))}</div>
                ${a.confirmation ? `<div class="muted">Conf: ${escapeHtml(a.confirmation)}</div>` : ""}
              </div>
              <div class="inlineBtns">
                <span class="pill">All-Inclusive</span>
                <button class="danger" data-del="ai" data-id="${escapeHtml(a.id)}">Delete</button>
              </div>
            </div>
          `).join("")
        : '<div class="muted">No all-inclusive packages yet.</div>';
    }

    // Delete detail items (delegated)
    $("manageModal").addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-del]");
      if (!btn) return;

      const kind = btn.dataset.del;
      const id = btn.dataset.id;
      if (!confirm("Delete this item?")) return;

      const path =
        kind === "cabin" ? `/api/cruise-cabins/${encodeURIComponent(id)}` :
        kind === "flight" ? `/api/flight-segments/${encodeURIComponent(id)}` :
        kind === "hotel" ? `/api/hotel-rooms/${encodeURIComponent(id)}` :
        `/api/ai-packages/${encodeURIComponent(id)}`;

      try {
        await apiFetch(path, { method: "DELETE" });
        await refreshManageModal();
      } catch (err) {
        alert("Delete failed: " + err.message);
      }
    });

    // Add cabin
    $("addCabinBtn").onclick = async () => {
      if(!currentTripId) return;
      try {
        await apiFetch(`/api/trips/${encodeURIComponent(currentTripId)}/cruise-cabins`, {
          method:"POST",
          body: JSON.stringify({
            cabin_no: $("cabinNo").value.trim() || null,
            category: $("cabinCat").value.trim() || null,
            deck: $("cabinDeck").value.trim() || null,
            guests: $("cabinGuests").value ? Number($("cabinGuests").value) : null,
            notes: $("cabinNotes").value.trim() || null
          })
        });
        ["cabinNo","cabinCat","cabinDeck","cabinGuests","cabinNotes"].forEach(id => $(id).value = "");
        await refreshManageModal();
      } catch (e) {
        alert("Add cabin failed: " + e.message);
      }
    };

    // Add flight
    $("addFlightBtn").onclick = async () => {
      if(!currentTripId) return;
      try {
        await apiFetch(`/api/trips/${encodeURIComponent(currentTripId)}/flights`, {
          method:"POST",
          body: JSON.stringify({
            carrier: $("fltCarrier").value.trim() || null,
            flight_no: $("fltNo").value.trim() || null,
            depart_airport: $("fltDep").value.trim() || null,
            arrive_airport: $("fltArr").value.trim() || null,
            depart_ts: dtToTs($("fltDepTs").value),
            arrive_ts: dtToTs($("fltArrTs").value),
            record_locator: $("fltRec").value.trim() || null
          })
        });
        ["fltCarrier","fltNo","fltDep","fltArr","fltDepTs","fltArrTs","fltRec"].forEach(id => $(id).value = "");
        await refreshManageModal();
      } catch (e) {
        alert("Add flight failed: " + e.message);
      }
    };

    // Add hotel
    $("addHotelBtn").onclick = async () => {
      if(!currentTripId) return;
      try {
        await apiFetch(`/api/trips/${encodeURIComponent(currentTripId)}/hotel-rooms`, {
          method:"POST",
          body: JSON.stringify({
            hotel_name: $("hotelName").value.trim() || null,
            room_type: $("hotelRoomType").value.trim() || null,
            check_in_ts: dtToTs($("hotelIn").value),
            check_out_ts: dtToTs($("hotelOut").value),
            occupants: $("hotelOcc").value ? Number($("hotelOcc").value) : null,
            confirmation: $("hotelConf").value.trim() || null
          })
        });
        ["hotelName","hotelRoomType","hotelIn","hotelOut","hotelOcc","hotelConf"].forEach(id => $(id).value = "");
        await refreshManageModal();
      } catch (e) {
        alert("Add hotel failed: " + e.message);
      }
    };

    // Add all-inclusive
    $("addAIBtn").onclick = async () => {
      if(!currentTripId) return;
      try {
        await apiFetch(`/api/trips/${encodeURIComponent(currentTripId)}/all-inclusive`, {
          method:"POST",
          body: JSON.stringify({
            resort_name: $("aiResort").value.trim() || null,
            plan_name: $("aiPlan").value.trim() || null,
            check_in_ts: dtToTs($("aiIn").value),
            check_out_ts: dtToTs($("aiOut").value),
            occupants: $("aiOcc").value ? Number($("aiOcc").value) : null,
            confirmation: $("aiConf").value.trim() || null
          })
        });
        ["aiResort","aiPlan","aiIn","aiOut","aiOcc","aiConf"].forEach(id => $(id).value = "");
        await refreshManageModal();
      } catch (e) {
        alert("Add all-inclusive failed: " + e.message);
      }
    };

    // ----------------------------
    // Initial defaults + initial loads
    // ----------------------------
    (async function init() {
      if (!$("tripGroupId").value) $("tripGroupId").value = "g1";
      if (!$("tripListGroupId").value) $("tripListGroupId").value = "g1";
      if (!$("payGroupId").value) $("payGroupId").value = "g1";
      if (!$("payListGroupId").value) $("payListGroupId").value = "g1";
      if (!$("brandId").value) $("brandId").value = "b1";

      try { await loadTrips(); } catch {}
      try { await loadPayments(); } catch {}
    })();
  </script>
</body>
</html>
